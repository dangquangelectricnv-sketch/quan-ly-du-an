<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªá Th·ªëng Qu·∫£n L√Ω D·ª± √Ån & C√¥ng N·ª£</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
      }

      .container {
          max-width: 1400px;
          margin: 0 auto;
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 30px;
          text-align: center;
      }

      .header h1 {
          font-size: 2.5em;
          margin-bottom: 10px;
      }

      .tabs {
          display: flex;
          background: #f8f9fa;
          border-bottom: 2px solid #dee2e6;
          overflow-x: auto;
      }

      .tab {
          padding: 15px 25px;
          cursor: pointer;
          border: none;
          background: none;
          font-size: 16px;
          font-weight: 600;
          color: #6c757d;
          transition: all 0.3s;
          white-space: nowrap;
      }

      .tab:hover {
          background: #e9ecef;
          color: #495057;
      }

      .tab.active {
          background: white;
          color: #667eea;
          border-bottom: 3px solid #667eea;
      }

      .content {
          padding: 30px;
      }

      .tab-content {
          display: none;
      }

      .tab-content.active {
          display: block;
          animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #495057;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
          width: 100%;
          padding: 12px;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          font-size: 14px;
          transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: #667eea;
      }

      .form-row {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
      }

      .btn {
          padding: 12px 30px;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-right: 10px;
      }

      .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
          background: #28a745;
          color: white;
      }

      .btn-danger {
          background: #dc3545;
          color: white;
      }

      .btn-warning {
          background: #ffc107;
          color: #212529;
      }

      .btn-info {
          background: #17a2b8;
          color: white;
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
      }

      .project-card {
          background: white;
          border: 2px solid #e9ecef;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 20px;
          transition: all 0.3s;
      }

      .project-card.rejected {
          background: #fff5f5;
          border-color: #ffcdd2;
          opacity: 0.9;
      }

      .project-card:hover {
          box-shadow: 0 5px 20px rgba(0,0,0,0.1);
          transform: translateY(-2px);
      }

      .project-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
      }

      .project-title {
          font-size: 1.3em;
          font-weight: 700;
          color: #212529;
      }

      .status-badge {
          padding: 6px 15px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          text-transform: uppercase;
      }

      .status-quote { background: #e3f2fd; color: #1976d2; }
      .status-design { background: #f3e5f5; color: #7b1fa2; }
      .status-production { background: #fff3e0; color: #e65100; }
      .status-delivery { background: #e8f5e9; color: #2e7d32; }
      .status-installation { background: #fce4ec; color: #c2185b; }
      .status-payment { background: #e0f2f1; color: #00695c; }
      .status-rejected { background: #ffebee; color: #c62828; }
      .status-completed { background: #c8e6c9; color: #1b5e20; }

      .project-info {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-bottom: 15px;
      }

      .info-item {
          display: flex;
          flex-direction: column;
      }

      .info-label {
          font-size: 12px;
          color: #6c757d;
          margin-bottom: 5px;
      }

      .info-value {
          font-size: 14px;
          font-weight: 600;
          color: #212529;
      }

      .progress-bar {
          width: 100%;
          height: 8px;
          background: #e9ecef;
          border-radius: 10px;
          overflow: hidden;
          margin: 15px 0;
      }

      .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
          transition: width 0.5s;
      }

      .action-buttons {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }

      .stat-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 25px;
          border-radius: 12px;
          text-align: center;
      }

      .stat-card h3 {
          font-size: 2.5em;
          margin-bottom: 10px;
      }

      .stat-card p {
          font-size: 1em;
          opacity: 0.9;
      }

      .filter-bar {
          display: flex;
          gap: 15px;
          margin-bottom: 25px;
          flex-wrap: wrap;
      }

      .filter-bar select,
      .filter-bar input {
          padding: 10px 15px;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          font-size: 14px;
      }

      .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          z-index: 1000;
          align-items: center;
          justify-content: center;
      }

      .modal.active {
          display: flex;
      }

      .modal-content {
          background: white;
          padding: 30px;
          border-radius: 12px;
          max-width: 700px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
      }

      .modal-header h2 {
          color: #212529;
      }

      .close-modal {
          font-size: 28px;
          cursor: pointer;
          color: #6c757d;
          background: none;
          border: none;
      }

      .production-steps {
          margin-top: 20px;
      }

      .step-item {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 10px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .step-completed {
          background: #d4edda;
          border-left: 4px solid #28a745;
      }

      .checkbox-group {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-top: 10px;
      }

      .debt-section {
          background: #f8f9fa;
          border-radius: 12px;
          padding: 20px;
          margin-top: 15px;
          border-left: 4px solid #667eea;
      }

      .debt-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
      }

      .debt-title {
          font-size: 1.2em;
          font-weight: 700;
          color: #212529;
      }

      .debt-summary {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 15px;
          margin-bottom: 20px;
      }

      .debt-item {
          background: white;
          padding: 15px;
          border-radius: 8px;
          text-align: center;
      }

      .debt-label {
          font-size: 12px;
          color: #6c757d;
          margin-bottom: 5px;
      }

      .debt-value {
          font-size: 1.5em;
          font-weight: 700;
      }

      .debt-value.positive {
          color: #28a745;
      }

      .debt-value.negative {
          color: #dc3545;
      }

      .debt-value.neutral {
          color: #ffc107;
      }

      .payment-history {
          margin-top: 20px;
      }

      .payment-item {
          background: white;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 10px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-left: 4px solid #28a745;
      }

      .payment-info {
          flex: 1;
      }

      .payment-date {
          font-size: 12px;
          color: #6c757d;
          margin-bottom: 5px;
      }

      .payment-amount {
          font-size: 1.2em;
          font-weight: 700;
          color: #28a745;
      }

      .payment-note {
          font-size: 14px;
          color: #495057;
          margin-top: 5px;
      }

      .delete-payment {
          background: #dc3545;
          color: white;
          border: none;
          padding: 8px 15px;
          border-radius: 5px;
          cursor: pointer;
          font-size: 12px;
      }

      .debt-alert {
          background: #fff3cd;
          border: 2px solid #ffc107;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 15px;
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .debt-alert.danger {
          background: #f8d7da;
          border-color: #dc3545;
      }

      .debt-alert.success {
          background: #d4edda;
          border-color: #28a745;
      }

      .table-responsive {
          overflow-x: auto;
      }

      table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
      }

      table th,
      table td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #e9ecef;
      }

      table th {
          background: #f8f9fa;
          font-weight: 600;
          color: #495057;
      }

      table tr:hover {
          background: #f8f9fa;
      }

      .rejected-info {
          background: #fff3cd;
          border-left: 4px solid #ffc107;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 15px;
      }

      .rejected-reason {
          background: #ffebee;
          border-left: 4px solid #dc3545;
          padding: 15px;
          border-radius: 8px;
          margin-top: 15px;
      }

      .rejected-reason h4 {
          color: #c62828;
          margin-bottom: 10px;
      }

      .timeline {
          margin-top: 20px;
      }

      .timeline-item {
          display: flex;
          gap: 15px;
          margin-bottom: 15px;
          padding: 10px;
          background: #f8f9fa;
          border-radius: 8px;
      }

      .timeline-icon {
          font-size: 24px;
      }

      .timeline-content {
          flex: 1;
      }

      .timeline-date {
          font-size: 12px;
          color: #6c757d;
      }

      .timeline-text {
          font-weight: 600;
          color: #212529;
          margin-top: 5px;
      }

      .empty-state {
          text-align: center;
          padding: 60px 20px;
          color: #6c757d;
      }

      .empty-state-icon {
          font-size: 64px;
          margin-bottom: 20px;
          opacity: 0.5;
      }

      .empty-state h3 {
          margin-bottom: 10px;
          color: #495057;
      }

      @media (max-width: 768px) {
          .header h1 {
              font-size: 1.8em;
          }

          .form-row {
              grid-template-columns: 1fr;
          }

          .project-info {
              grid-template-columns: 1fr;
          }

          .stats-grid {
              grid-template-columns: 1fr;
          }

          .debt-summary {
              grid-template-columns: 1fr;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>üè≠ H·ªÜ TH·ªêNG QU·∫¢N L√ù D·ª∞ √ÅN & C√îNG N·ª¢</h1>
          <p>Qu·∫£n l√Ω quy tr√¨nh t·ª´ b√°o gi√° ƒë·∫øn thanh to√°n & theo d√µi c√¥ng n·ª£ chi ti·∫øt</p>
      </div>

      <div class="tabs">
          <button class="tab active" onclick="switchTab('dashboard')">üìä T·ªïng Quan</button>
          <button class="tab" onclick="switchTab('debt')">üí∞ C√¥ng N·ª£</button>
          <button class="tab" onclick="switchTab('quote')">üìù B√°o Gi√°</button>
          <button class="tab" onclick="switchTab('rejected')">‚ùå B√°o Gi√° B·ªã Lo·∫°i</button>
          <button class="tab" onclick="switchTab('design')">üé® Thi·∫øt K·∫ø</button>
          <button class="tab" onclick="switchTab('production')">‚öôÔ∏è S·∫£n Xu·∫•t</button>
          <button class="tab" onclick="switchTab('delivery')">üöö Giao H√†ng</button>
          <button class="tab" onclick="switchTab('installation')">üîß L·∫Øp ƒê·∫∑t</button>
          <button class="tab" onclick="switchTab('payment')">üí≥ Thanh To√°n</button>
      </div>

      <div class="content">
          <!-- Dashboard Tab -->
          <div id="dashboard" class="tab-content active">
              <h2 style="margin-bottom: 20px;">Th·ªëng K√™ T·ªïng Quan</h2>
              <div class="stats-grid">
                  <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                      <h3 id="totalProjects">0</h3>
                      <p>T·ªïng D·ª± √Ån</p>
                  </div>
                  <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                      <h3 id="activeProjects">0</h3>
                      <p>ƒêang Th·ª±c Hi·ªán</p>
                  </div>
                  <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                      <h3 id="completedProjects">0</h3>
                      <p>Ho√†n Th√†nh</p>
                  </div>
                  <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                      <h3 id="totalRevenue">0ƒë</h3>
                      <p>T·ªïng Doanh Thu</p>
                  </div>
                  <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                      <h3 id="totalDebt">0ƒë</h3>
                      <p>T·ªïng C√¥ng N·ª£</p>
                  </div>
                  <div class="stat-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">
                      <h3 id="rejectedProjects">0</h3>
                      <p>B√°o Gi√° B·ªã Lo·∫°i</p>
                  </div>
              </div>

              <h3 style="margin-bottom: 15px;">Danh S√°ch D·ª± √Ån</h3>
              <div class="filter-bar">
                  <select id="filterStatus" onchange="filterProjects()">
                      <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                      <option value="quote">B√°o gi√°</option>
                      <option value="design">Thi·∫øt k·∫ø</option>
                      <option value="production">S·∫£n xu·∫•t</option>
                      <option value="delivery">Giao h√†ng</option>
                      <option value="installation">L·∫Øp ƒë·∫∑t</option>
                      <option value="payment">Thanh to√°n</option>
                      <option value="completed">Ho√†n th√†nh</option>
                  </select>
                  <select id="filterDebt" onchange="filterProjects()">
                      <option value="">T·∫•t c·∫£ c√¥ng n·ª£</option>
                      <option value="has-debt">C√≤n n·ª£</option>
                      <option value="paid">ƒê√£ thanh to√°n</option>
                  </select>
                  <input type="text" id="searchProject" placeholder="üîç T√¨m ki·∫øm d·ª± √°n..." oninput="filterProjects()">
              </div>
              <div id="projectsList"></div>
          </div>

          <!-- Debt Management Tab -->
          <div id="debt" class="tab-content">
              <h2 style="margin-bottom: 20px;">Qu·∫£n L√Ω C√¥ng N·ª£</h2>
              
              <div class="stats-grid">
                  <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                      <h3 id="debtTotal">0ƒë</h3>
                      <p>T·ªïng C√¥ng N·ª£</p>
                  </div>
                  <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                      <h3 id="debtPaid">0ƒë</h3>
                      <p>ƒê√£ Thu</p>
                  </div>
                  <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                      <h3 id="debtRemaining">0ƒë</h3>
                      <p>C√≤n L·∫°i</p>
                  </div>
                  <div class="stat-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                      <h3 id="debtProjects">0</h3>
                      <p>D·ª± √Ån C√≤n N·ª£</p>
                  </div>
              </div>

              <h3 style="margin-bottom: 15px;">Danh S√°ch C√¥ng N·ª£</h3>
              <div class="table-responsive">
                  <table id="debtTable">
                      <thead>
                          <tr>
                              <th>M√£ DA</th>
                              <th>T√™n D·ª± √Ån</th>
                              <th>Kh√°ch H√†ng</th>
                              <th>T·ªïng Gi√° Tr·ªã</th>
                              <th>ƒê√£ Thanh To√°n</th>
                              <th>C√≤n L·∫°i</th>
                              <th>Tr·∫°ng Th√°i</th>
                              <th>Thao T√°c</th>
                          </tr>
                      </thead>
                      <tbody id="debtTableBody">
                      </tbody>
                  </table>
              </div>
          </div>

          <!-- Quote Tab -->
          <div id="quote" class="tab-content">
              <h2 style="margin-bottom: 20px;">T·∫°o B√°o Gi√° M·ªõi</h2>
              <form onsubmit="createQuote(event)">
                  <div class="form-row">
                      <div class="form-group">
                          <label>M√£ D·ª± √Ån *</label>
                          <input type="text" id="projectCode" required placeholder="VD: DA001">
                      </div>
                      <div class="form-group">
                          <label>T√™n D·ª± √Ån *</label>
                          <input type="text" id="projectName" required placeholder="Nh·∫≠p t√™n d·ª± √°n">
                      </div>
                  </div>
                  <div class="form-row">
                      <div class="form-group">
                          <label>Kh√°ch H√†ng *</label>
                          <input type="text" id="customerName" required placeholder="T√™n kh√°ch h√†ng">
                      </div>
                      <div class="form-group">
                          <label>S·ªë ƒêi·ªán Tho·∫°i</label>
                          <input type="tel" id="customerPhone" placeholder="0123456789">
                      </div>
                  </div>
                  <div class="form-row">
                      <div class="form-group">
                          <label>Gi√° Tr·ªã B√°o Gi√° (VNƒê) *</label>
                          <input type="number" id="quoteValue" required placeholder="0">
                      </div>
                      <div class="form-group">
                          <label>Ng√†y B√°o Gi√° *</label>
                          <input type="date" id="quoteDate" required>
                      </div>
                  </div>
                  <div class="form-group">
                      <label>C·∫ßn L·∫Øp ƒê·∫∑t?</label>
                      <div class="checkbox-group">
                          <input type="checkbox" id="needInstallation">
                          <label for="needInstallation">D·ª± √°n c·∫ßn l·∫Øp ƒë·∫∑t</label>
                      </div>
                  </div>
                  <div class="form-group">
                      <label>Ghi Ch√∫</label>
                      <textarea id="quoteNote" rows="3" placeholder="Ghi ch√∫ v·ªÅ b√°o gi√°..."></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary">‚úÖ T·∫°o B√°o Gi√°</button>
              </form>

              <h3 style="margin-top: 40px; margin-bottom: 20px;">Danh S√°ch B√°o Gi√°</h3>
              <div id="quotesList"></div>
          </div>

          <!-- Rejected Quotes Tab -->
          <div id="rejected" class="tab-content">
              <h2 style="margin-bottom: 20px;">üìã B√°o Gi√° ƒê√£ B·ªã Lo·∫°i</h2>
              
              <div class="rejected-info">
                  <strong>‚ÑπÔ∏è Th√¥ng tin:</strong> ƒê√¢y l√† danh s√°ch c√°c b√°o gi√° ƒë√£ b·ªã t·ª´ ch·ªëi. B·∫°n c√≥ th·ªÉ xem l·∫°i th√¥ng tin, kh√¥i ph·ª•c ho·∫∑c x√≥a vƒ©nh vi·ªÖn.
              </div>

              <div class="filter-bar">
                  <input type="text" id="searchRejected" placeholder="üîç T√¨m ki·∫øm b√°o gi√° b·ªã lo·∫°i..." oninput="renderRejectedQuotes()">
                  <select id="sortRejected" onchange="renderRejectedQuotes()">
                      <option value="newest">M·ªõi nh·∫•t</option>
                      <option value="oldest">C≈© nh·∫•t</option>
                      <option value="value-high">Gi√° tr·ªã cao</option>
                      <option value="value-low">Gi√° tr·ªã th·∫•p</option>
                  </select>
              </div>

              <div id="rejectedList"></div>
          </div>

          <!-- Design Tab -->
          <div id="design" class="tab-content">
              <h2 style="margin-bottom: 20px;">Qu·∫£n L√Ω Thi·∫øt K·∫ø</h2>
              <div id="designList"></div>
          </div>

          <!-- Production Tab -->
          <div id="production" class="tab-content">
              <h2 style="margin-bottom: 20px;">Qu·∫£n L√Ω S·∫£n Xu·∫•t</h2>
              <div id="productionList"></div>
          </div>

          <!-- Delivery Tab -->
          <div id="delivery" class="tab-content">
              <h2 style="margin-bottom: 20px;">Qu·∫£n L√Ω Giao H√†ng</h2>
              <div id="deliveryList"></div>
          </div>

          <!-- Installation Tab -->
          <div id="installation" class="tab-content">
              <h2 style="margin-bottom: 20px;">Qu·∫£n L√Ω L·∫Øp ƒê·∫∑t</h2>
              <div id="installationList"></div>
          </div>

          <!-- Payment Tab -->
          <div id="payment" class="tab-content">
              <h2 style="margin-bottom: 20px;">Qu·∫£n L√Ω Thanh To√°n</h2>
              <div id="paymentList"></div>
          </div>
      </div>
  </div>

  <!-- Modal for Production Details -->
  <div id="productionModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2>Chi Ti·∫øt S·∫£n Xu·∫•t</h2>
              <button class="close-modal" onclick="closeModal('productionModal')">&times;</button>
          </div>
          <div id="productionModalContent"></div>
      </div>
  </div>

  <!-- Modal for Debt Management -->
  <div id="debtModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2>Qu·∫£n L√Ω C√¥ng N·ª£</h2>
              <button class="close-modal" onclick="closeModal('debtModal')">&times;</button>
          </div>
          <div id="debtModalContent"></div>
      </div>
  </div>

  <!-- Modal for Rejected Quote Details -->
  <div id="rejectedModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2>Chi Ti·∫øt B√°o Gi√° B·ªã Lo·∫°i</h2>
              <button class="close-modal" onclick="closeModal('rejectedModal')">&times;</button>
          </div>
          <div id="rejectedModalContent"></div>
      </div>
  </div>

  <script>
      let projects = JSON.parse(localStorage.getItem('projects')) || [];

      function switchTab(tabName) {
          document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          
          event.target.classList.add('active');
          document.getElementById(tabName).classList.add('active');
          
          renderContent();
      }

      function createQuote(event) {
          event.preventDefault();
          
          const project = {
              id: Date.now(),
              code: document.getElementById('projectCode').value,
              name: document.getElementById('projectName').value,
              customer: document.getElementById('customerName').value,
              phone: document.getElementById('customerPhone').value,
              value: parseInt(document.getElementById('quoteValue').value),
              quoteDate: document.getElementById('quoteDate').value,
              needInstallation: document.getElementById('needInstallation').checked,
              note: document.getElementById('quoteNote').value,
              status: 'quote',
              createdAt: new Date().toISOString(),
              timeline: [{
                  step: 'quote',
                  date: new Date().toISOString(),
                  note: 'T·∫°o b√°o gi√°'
              }],
              production: {
                  orderMaterials: false,
                  assembly: false,
                  testing: false
              },
              payments: [],
              totalPaid: 0
          };

          projects.push(project);
          saveProjects();
          
          event.target.reset();
          alert('‚úÖ T·∫°o b√°o gi√° th√†nh c√¥ng!');
          renderContent();
      }

      function approveQuote(id) {
          const project = projects.find(p => p.id === id);
          if (project) {
              project.status = 'design';
              project.timeline.push({
                  step: 'design',
                  date: new Date().toISOString(),
                  note: 'Chuy·ªÉn sang thi·∫øt k·∫ø'
              });
              saveProjects();
              renderContent();
              alert('‚úÖ B√°o gi√° ƒë∆∞·ª£c ch·∫•p nh·∫≠n! Chuy·ªÉn sang giai ƒëo·∫°n thi·∫øt k·∫ø.');
          }
      }

      function rejectQuote(id) {
          const reason = prompt('L√Ω do t·ª´ ch·ªëi b√°o gi√°:');
          if (reason !== null) {
              const project = projects.find(p => p.id === id);
              if (project) {
                  project.status = 'rejected';
                  project.rejectedReason = reason || 'Kh√¥ng c√≥ l√Ω do c·ª• th·ªÉ';
                  project.rejectedDate = new Date().toISOString();
                  project.timeline.push({
                      step: 'rejected',
                      date: new Date().toISOString(),
                      note: `B√°o gi√° b·ªã t·ª´ ch·ªëi: ${project.rejectedReason}`
                  });
                  saveProjects();
                  renderContent();
                  alert('‚ùå B√°o gi√° ƒë√£ b·ªã t·ª´ ch·ªëi!');
              }
          }
      }

      function restoreQuote(id) {
          if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën kh√¥i ph·ª•c b√°o gi√° n√†y?')) {
              const project = projects.find(p => p.id === id);
              if (project) {
                  project.status = 'quote';
                  project.timeline.push({
                      step: 'restored',
                      date: new Date().toISOString(),
                      note: 'Kh√¥i ph·ª•c b√°o gi√°'
                  });
                  delete project.rejectedReason;
                  delete project.rejectedDate;
                  saveProjects();
                  renderContent();
                  alert('‚úÖ ƒê√£ kh√¥i ph·ª•c b√°o gi√°!');
              }
          }
      }

      function viewRejectedDetails(id) {
          const project = projects.find(p => p.id === id);
          if (!project) return;

          const modal = document.getElementById('rejectedModal');
          const content = document.getElementById('rejectedModalContent');

          content.innerHTML = `
              <div class="project-info">
                  <div class="info-item">
                      <span class="info-label">M√£ D·ª± √Ån</span>
                      <span class="info-value">${project.code}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">T√™n D·ª± √Ån</span>
                      <span class="info-value">${project.name}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">Kh√°ch H√†ng</span>
                      <span class="info-value">${project.customer}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">S·ªë ƒêi·ªán Tho·∫°i</span>
                      <span class="info-value">${project.phone || 'Kh√¥ng c√≥'}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">Gi√° Tr·ªã</span>
                      <span class="info-value">${formatCurrency(project.value)}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">Ng√†y B√°o Gi√°</span>
                      <span class="info-value">${formatDate(project.quoteDate)}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">Ng√†y T·ª´ Ch·ªëi</span>
                      <span class="info-value">${formatDate(project.rejectedDate)}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">L·∫Øp ƒê·∫∑t</span>
                      <span class="info-value">${project.needInstallation ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</span>
                  </div>
              </div>

              <div class="rejected-reason">
                  <h4>‚ùå L√Ω Do T·ª´ Ch·ªëi</h4>
                  <p>${project.rejectedReason}</p>
              </div>

              ${project.note ? `
                  <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                      <strong>üìù Ghi Ch√∫:</strong>
                      <p style="margin-top: 5px;">${project.note}</p>
                  </div>
              ` : ''}

              <div class="timeline">
                  <h4 style="margin-bottom: 15px;">üìÖ L·ªãch S·ª≠</h4>
                  ${project.timeline.map(item => `
                      <div class="timeline-item">
                          <div class="timeline-icon">${getTimelineIcon(item.step)}</div>
                          <div class="timeline-content">
                              <div class="timeline-date">${formatDateTime(item.date)}</div>
                              <div class="timeline-text">${item.note}</div>
                          </div>
                      </div>
                  `).reverse().join('')}
              </div>

              <div style="margin-top: 25px; display: flex; gap: 10px;">
                  <button class="btn btn-success" onclick="restoreQuote(${project.id}); closeModal('rejectedModal')">
                      ‚ôªÔ∏è Kh√¥i Ph·ª•c B√°o Gi√°
                  </button>
                  <button class="btn btn-danger" onclick="permanentDeleteProject(${project.id}); closeModal('rejectedModal')">
                      üóëÔ∏è X√≥a Vƒ©nh Vi·ªÖn
                  </button>
              </div>
          `;

          modal.classList.add('active');
      }

      function getTimelineIcon(step) {
          const icons = {
              'quote': 'üìù',
              'rejected': '‚ùå',
              'restored': '‚ôªÔ∏è',
              'design': 'üé®',
              'production': '‚öôÔ∏è',
              'delivery': 'üöö',
              'installation': 'üîß',
              'payment': 'üí∞',
              'completed': '‚úÖ'
          };
          return icons[step] || 'üìå';
      }

      function permanentDeleteProject(id) {
          if (confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a vƒ©nh vi·ªÖn d·ª± √°n n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
              projects = projects.filter(p => p.id !== id);
              saveProjects();
              renderContent();
              alert('üóëÔ∏è ƒê√£ x√≥a vƒ©nh vi·ªÖn d·ª± √°n!');
          }
      }

      function renderRejectedQuotes() {
          const search = document.getElementById('searchRejected').value.toLowerCase();
          const sort = document.getElementById('sortRejected').value;
          
          let rejected = projects.filter(p => p.status === 'rejected');

          // Filter by search
          if (search) {
              rejected = rejected.filter(p => 
                  p.code.toLowerCase().includes(search) ||
                  p.name.toLowerCase().includes(search) ||
                  p.customer.toLowerCase().includes(search) ||
                  (p.rejectedReason && p.rejectedReason.toLowerCase().includes(search))
              );
          }

          // Sort
          switch(sort) {
              case 'newest':
                  rejected.sort((a, b) => new Date(b.rejectedDate) - new Date(a.rejectedDate));
                  break;
              case 'oldest':
                  rejected.sort((a, b) => new Date(a.rejectedDate) - new Date(b.rejectedDate));
                  break;
              case 'value-high':
                  rejected.sort((a, b) => b.value - a.value);
                  break;
              case 'value-low':
                  rejected.sort((a, b) => a.value - b.value);
                  break;
          }

          const listElement = document.getElementById('rejectedList');
          
          if (rejected.length === 0) {
              listElement.innerHTML = `
                  <div class="empty-state">
                      <div class="empty-state-icon">‚úÖ</div>
                      <h3>Kh√¥ng c√≥ b√°o gi√° b·ªã lo·∫°i</h3>
                      <p>T·∫•t c·∫£ b√°o gi√° ƒë·ªÅu ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω ho·∫∑c ƒë√£ ho√†n th√†nh</p>
                  </div>
              `;
          } else {
              listElement.innerHTML = rejected.map(project => `
                  <div class="project-card rejected">
                      <div class="project-header">
                          <div class="project-title">
                              ${project.code} - ${project.name}
                              <span style="font-size: 0.7em; color: #6c757d; font-weight: normal;">
                                  (T·ª´ ch·ªëi: ${formatDate(project.rejectedDate)})
                              </span>
                          </div>
                          <span class="status-badge status-rejected">ƒê√£ T·ª´ Ch·ªëi</span>
                      </div>
                      <div class="project-info">
                          <div class="info-item">
                              <span class="info-label">Kh√°ch h√†ng</span>
                              <span class="info-value">${project.customer}</span>
                          </div>
                          <div class="info-item">
                              <span class="info-label">Gi√° tr·ªã</span>
                              <span class="info-value">${formatCurrency(project.value)}</span>
                          </div>
                          <div class="info-item">
                              <span class="info-label">Ng√†y b√°o gi√°</span>
                              <span class="info-value">${formatDate(project.quoteDate)}</span>
                          </div>
                          <div class="info-item">
                              <span class="info-label">L·∫Øp ƒë·∫∑t</span>
                              <span class="info-value">${project.needInstallation ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</span>
                          </div>
                      </div>
                      <div class="rejected-reason">
                          <h4>L√Ω do t·ª´ ch·ªëi:</h4>
                          <p>${project.rejectedReason}</p>
                      </div>
                      <div class="action-buttons" style="margin-top: 15px;">
                          <button class="btn btn-info" onclick="viewRejectedDetails(${project.id})">
                              üëÅÔ∏è Xem Chi Ti·∫øt
                          </button>
                          <button class="btn btn-success" onclick="restoreQuote(${project.id})">
                              ‚ôªÔ∏è Kh√¥i Ph·ª•c
                          </button>
                          <button class="btn btn-danger" onclick="permanentDeleteProject(${project.id})">
                              üóëÔ∏è X√≥a Vƒ©nh Vi·ªÖn
                          </button>
                      </div>
                  </div>
              `).join('');
          }
      }

      function moveToProduction(id) {
          const project = projects.find(p => p.id === id);
          if (project) {
              project.status = 'production';
              project.timeline.push({
                  step: 'production',
                  date: new Date().toISOString(),
                  note: 'B·∫Øt ƒë·∫ßu s·∫£n xu·∫•t'
              });
              saveProjects();
              renderContent();
              alert('‚úÖ Chuy·ªÉn sang giai ƒëo·∫°n s·∫£n xu·∫•t!');
          }
      }

      function openProductionModal(id) {
          const project = projects.find(p => p.id === id);
          if (!project) return;

          const modal = document.getElementById('productionModal');
          const content = document.getElementById('productionModalContent');
          
          content.innerHTML = `
              <h3>${project.name}</h3>
              <div class="production-steps">
                  <div class="step-item ${project.production.orderMaterials ? 'step-completed' : ''}">
                      <span>üì¶ ƒê·∫∑t v·∫≠t t∆∞</span>
                      <input type="checkbox" ${project.production.orderMaterials ? 'checked' : ''} 
                             onchange="updateProductionStep(${id}, 'orderMaterials', this.checked)">
                  </div>
                  <div class="step-item ${project.production.assembly ? 'step-completed' : ''}">
                      <span>üîß L·∫Øp r√°p</span>
                      <input type="checkbox" ${project.production.assembly ? 'checked' : ''} 
                             onchange="updateProductionStep(${id}, 'assembly', this.checked)">
                  </div>
                  <div class="step-item ${project.production.testing ? 'step-completed' : ''}">
                      <span>‚úÖ Test xu·∫•t x∆∞·ªüng</span>
                      <input type="checkbox" ${project.production.testing ? 'checked' : ''} 
                             onchange="updateProductionStep(${id}, 'testing', this.checked)">
                  </div>
              </div>
              <button class="btn btn-success" onclick="completeProduction(${id})" 
                      ${project.production.orderMaterials && project.production.assembly && project.production.testing ? '' : 'disabled'}>
                  Ho√†n Th√†nh S·∫£n Xu·∫•t
              </button>
          `;
          
          modal.classList.add('active');
      }

      function updateProductionStep(id, step, checked) {
          const project = projects.find(p => p.id === id);
          if (project) {
              project.production[step] = checked;
              saveProjects();
              openProductionModal(id);
          }
      }

      function completeProduction(id) {
          const project = projects.find(p => p.id === id);
          if (project && project.production.orderMaterials && project.production.assembly && project.production.testing) {
              project.status = 'delivery';
              project.timeline.push({
                  step: 'delivery',
                  date: new Date().toISOString(),
                  note: 'Ho√†n th√†nh s·∫£n xu·∫•t, chuy·ªÉn sang giao h√†ng'
              });
              saveProjects();
              closeModal('productionModal');
              renderContent();
              alert('‚úÖ Ho√†n th√†nh s·∫£n xu·∫•t! Chuy·ªÉn sang giai ƒëo·∫°n giao h√†ng.');
          }
      }

      function completeDelivery(id) {
          const project = projects.find(p => p.id === id);
          if (project) {
              if (project.needInstallation) {
                  project.status = 'installation';
                  project.timeline.push({
                      step: 'installation',
                      date: new Date().toISOString(),
                      note: 'Ho√†n th√†nh giao h√†ng, chuy·ªÉn sang l·∫Øp ƒë·∫∑t'
                  });
                  alert('‚úÖ Ho√†n th√†nh giao h√†ng! Chuy·ªÉn sang giai ƒëo·∫°n l·∫Øp ƒë·∫∑t.');
              } else {
                  project.status = 'payment';
                  project.timeline.push({
                      step: 'payment',
                      date: new Date().toISOString(),
                      note: 'Ho√†n th√†nh giao h√†ng, chuy·ªÉn sang thanh to√°n'
                  });
                  alert('‚úÖ Ho√†n th√†nh giao h√†ng! Chuy·ªÉn sang giai ƒëo·∫°n thanh to√°n.');
              }
              saveProjects();
              renderContent();
          }
      }

      function completeInstallation(id) {
          const project = projects.find(p => p.id === id);
          if (project) {
              project.status = 'payment';
              project.timeline.push({
                  step: 'payment',
                  date: new Date().toISOString(),
                  note: 'Ho√†n th√†nh l·∫Øp ƒë·∫∑t, chuy·ªÉn sang thanh to√°n'
              });
              saveProjects();
              renderContent();
              alert('‚úÖ Ho√†n th√†nh l·∫Øp ƒë·∫∑t! Chuy·ªÉn sang giai ƒëo·∫°n thanh to√°n.');
          }
      }

      function completePayment(id) {
          const project = projects.find(p => p.id === id);
          if (!project) return;

          const remaining = project.value - project.totalPaid;
          if (remaining > 0) {
              if (!confirm(`D·ª± √°n c√≤n n·ª£ ${formatCurrency(remaining)}. B·∫°n c√≥ ch·∫Øc mu·ªën ho√†n th√†nh?`)) {
                  return;
              }
          }

          project.status = 'completed';
          project.completedDate = new Date().toISOString();
          project.timeline.push({
              step: 'completed',
              date: new Date().toISOString(),
              note: 'Ho√†n th√†nh d·ª± √°n'
          });
          saveProjects();
          renderContent();
          alert('üéâ Ho√†n th√†nh d·ª± √°n!');
      }

      function openDebtModal(id) {
          const project = projects.find(p => p.id === id);
          if (!project) return;

          const modal = document.getElementById('debtModal');
          const content = document.getElementById('debtModalContent');
          
          const remaining = project.value - project.totalPaid;
          const percentage = (project.totalPaid / project.value * 100).toFixed(1);

          content.innerHTML = `
              <h3>${project.code} - ${project.name}</h3>
              <div class="debt-summary">
                  <div class="debt-item">
                      <div class="debt-label">T·ªïng Gi√° Tr·ªã</div>
                      <div class="debt-value neutral">${formatCurrency(project.value)}</div>
                  </div>
                  <div class="debt-item">
                      <div class="debt-label">ƒê√£ Thanh To√°n</div>
                      <div class="debt-value positive">${formatCurrency(project.totalPaid)}</div>
                  </div>
                  <div class="debt-item">
                      <div class="debt-label">C√≤n L·∫°i</div>
                      <div class="debt-value ${remaining > 0 ? 'negative' : 'positive'}">${formatCurrency(remaining)}</div>
                  </div>
                  <div class="debt-item">
                      <div class="debt-label">T·ª∑ L·ªá</div>
                      <div class="debt-value">${percentage}%</div>
                  </div>
              </div>

              ${remaining > 0 ? `
                  <div class="debt-alert ${remaining > project.value * 0.5 ? 'danger' : ''}">
                      <span style="font-size: 24px;">‚ö†Ô∏è</span>
                      <div>
                          <strong>C·∫£nh b√°o c√¥ng n·ª£</strong><br>
                          D·ª± √°n c√≤n n·ª£ ${formatCurrency(remaining)} (${(100 - percentage).toFixed(1)}%)
                      </div>
                  </div>
              ` : `
                  <div class="debt-alert success">
                      <span style="font-size: 24px;">‚úÖ</span>
                      <div>
                          <strong>ƒê√£ thanh to√°n ƒë·ªß</strong><br>
                          D·ª± √°n ƒë√£ ƒë∆∞·ª£c thanh to√°n 100%
                      </div>
                  </div>
              `}

              <div class="progress-bar" style="height: 20px; margin: 20px 0;">
                  <div class="progress-fill" style="width: ${percentage}%; background: ${percentage < 50 ? '#dc3545' : percentage < 100 ? '#ffc107' : '#28a745'}"></div>
              </div>

              <h4 style="margin-top: 25px; margin-bottom: 15px;">Th√™m Thanh To√°n M·ªõi</h4>
              <form onsubmit="addPayment(event, ${id})">
                  <div class="form-group">
                      <label>S·ªë Ti·ªÅn (VNƒê) *</label>
                      <input type="number" id="paymentAmount" required placeholder="0" max="${remaining}">
                  </div>
                  <div class="form-group">
                      <label>Ng√†y Thanh To√°n *</label>
                      <input type="date" id="paymentDate" required value="${new Date().toISOString().split('T')[0]}">
                  </div>
                  <div class="form-group">
                      <label>Ghi Ch√∫</label>
                      <textarea id="paymentNote" rows="2" placeholder="Ghi ch√∫ v·ªÅ kho·∫£n thanh to√°n..."></textarea>
                  </div>
                  <button type="submit" class="btn btn-success" ${remaining <= 0 ? 'disabled' : ''}>üí∞ Th√™m Thanh To√°n</button>
              </form>

              <div class="payment-history">
                  <h4 style="margin-bottom: 15px;">L·ªãch S·ª≠ Thanh To√°n (${project.payments.length})</h4>
                  ${project.payments.length === 0 ? 
                      '<p style="text-align: center; color: #6c757d; padding: 20px;">Ch∆∞a c√≥ thanh to√°n n√†o</p>' :
                      project.payments.map((payment, index) => `
                          <div class="payment-item">
                              <div class="payment-info">
                                  <div class="payment-date">üìÖ ${formatDate(payment.date)}</div>
                                  <div class="payment-amount">${formatCurrency(payment.amount)}</div>
                                  ${payment.note ? `<div class="payment-note">${payment.note}</div>` : ''}
                              </div>
                              <button class="delete-payment" onclick="deletePayment(${id}, ${index})">üóëÔ∏è X√≥a</button>
                          </div>
                      `).reverse().join('')
                  }
              </div>
          `;
          
          modal.classList.add('active');
      }

      function addPayment(event, projectId) {
          event.preventDefault();
          
          const project = projects.find(p => p.id === projectId);
          if (!project) return;

          const amount = parseInt(document.getElementById('paymentAmount').value);
          const date = document.getElementById('paymentDate').value;
          const note = document.getElementById('paymentNote').value;

          const remaining = project.value - project.totalPaid;
          if (amount > remaining) {
              alert(`‚ö†Ô∏è S·ªë ti·ªÅn thanh to√°n v∆∞·ª£t qu√° s·ªë ti·ªÅn c√≤n l·∫°i (${formatCurrency(remaining)})`);
              return;
          }

          const payment = {
              amount: amount,
              date: date,
              note: note,
              createdAt: new Date().toISOString()
          };

          project.payments.push(payment);
          project.totalPaid += amount;
          
          project.timeline.push({
              step: 'payment',
              date: new Date().toISOString(),
              note: `Thanh to√°n ${formatCurrency(amount)}`
          });

          saveProjects();
          openDebtModal(projectId);
          renderContent();
          alert('‚úÖ Th√™m thanh to√°n th√†nh c√¥ng!');
      }

      function deletePayment(projectId, paymentIndex) {
          if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kho·∫£n thanh to√°n n√†y?')) return;

          const project = projects.find(p => p.id === projectId);
          if (!project) return;

          const payment = project.payments[paymentIndex];
          project.totalPaid -= payment.amount;
          project.payments.splice(paymentIndex, 1);

          saveProjects();
          openDebtModal(projectId);
          renderContent();
      }

      function deleteProject(id) {
          if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d·ª± √°n n√†y?')) {
              projects = projects.filter(p => p.id !== id);
              saveProjects();
              renderContent();
          }
      }

      function closeModal(modalId) {
          document.getElementById(modalId).classList.remove('active');
      }

      function getStatusText(status) {
          const statusMap = {
              'quote': 'B√°o gi√°',
              'design': 'Thi·∫øt k·∫ø',
              'production': 'S·∫£n xu·∫•t',
              'delivery': 'Giao h√†ng',
              'installation': 'L·∫Øp ƒë·∫∑t',
              'payment': 'Thanh to√°n',
              'rejected': 'ƒê√£ t·ª´ ch·ªëi',
              'completed': 'Ho√†n th√†nh'
          };
          return statusMap[status] || status;
      }

      function getProgress(status) {
          const progressMap = {
              'quote': 10,
              'design': 25,
              'production': 50,
              'delivery': 70,
              'installation': 85,
              'payment': 95,
              'completed': 100,
              'rejected': 0
          };
          return progressMap[status] || 0;
      }

      function formatCurrency(amount) {
          return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
      }

      function formatDate(dateString) {
          return new Date(dateString).toLocaleDateString('vi-VN');
      }

      function formatDateTime(dateString) {
          return new Date(dateString).toLocaleString('vi-VN');
      }

      function renderProjectCard(project) {
          const progress = getProgress(project.status);
          const remaining = project.value - project.totalPaid;
          const paymentPercentage = (project.totalPaid / project.value * 100).toFixed(0);
          
          return `
              <div class="project-card">
                  <div class="project-header">
                      <div class="project-title">${project.code} - ${project.name}</div>
                      <span class="status-badge status-${project.status}">${getStatusText(project.status)}</span>
                  </div>
                  <div class="project-info">
                      <div class="info-item">
                          <span class="info-label">Kh√°ch h√†ng</span>
                          <span class="info-value">${project.customer}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">Gi√° tr·ªã</span>
                          <span class="info-value">${formatCurrency(project.value)}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">ƒê√£ thanh to√°n</span>
                          <span class="info-value" style="color: #28a745;">${formatCurrency(project.totalPaid)} (${paymentPercentage}%)</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">C√≤n l·∫°i</span>
                          <span class="info-value" style="color: ${remaining > 0 ? '#dc3545' : '#28a745'};">${formatCurrency(remaining)}</span>
                      </div>
                  </div>

                  ${remaining > 0 && project.status !== 'quote' && project.status !== 'rejected' ? `
                      <div class="debt-alert" style="margin: 15px 0;">
                          <span style="font-size: 20px;">üí∞</span>
                          <div style="flex: 1;">
                              <strong>